services:
  api:
    # The deployment script will pull the latest image before starting
    # Supports DOCKER_IMAGE_TAG environment variable for SHA-tagged deployments
    image: ${DOCKER_IMAGE_TAG:-kamilzafar/ict_agent:latest}
    container_name: ict_agent_api
    ports:
      - "${API_PORT:-8009}:8009"  # Expose API port for OAuth2 callbacks
    env_file:
      - .env
    environment:
      - MEMORY_DB_PATH=/app/memory_db
      - ENVIRONMENT=production
      # FastAPI Production Settings
      - WORKERS=${WORKERS:-4}
      - MAX_CONCURRENT=${MAX_CONCURRENT:-100}
      - KEEP_ALIVE=${KEEP_ALIVE:-120}
      - TIMEOUT=${TIMEOUT:-120}
      - BACKLOG=${BACKLOG:-2048}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Supabase Configuration
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_KEY=${SUPABASE_KEY:-}
      - SUPABASE_REALTIME_ENABLED=${SUPABASE_REALTIME_ENABLED:-true}
      # Google Sheets Configuration (optional)
      - GOOGLE_SHEETS_CREDENTIALS_PATH=${GOOGLE_SHEETS_CREDENTIALS_PATH:-}
      - GOOGLE_SHEETS_SPREADSHEET_ID=${GOOGLE_SHEETS_SPREADSHEET_ID:-}
      - GOOGLE_SHEETS_LEADS_SHEET_NAME=${GOOGLE_SHEETS_LEADS_SHEET_NAME:-Leads}
      # LangChain/LangGraph Settings
      - SUMMARIZE_INTERVAL=${SUMMARIZE_INTERVAL:-10}
      - RECURSION_LIMIT=${RECURSION_LIMIT:-50}
      - MODEL_NAME=${MODEL_NAME:-gpt-4.1-mini}
      - TEMPERATURE=${TEMPERATURE:-0.7}
    
    # Resource limits to prevent OOM kills during ChromaDB indexing
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    volumes:
      # Persist memory database (bind mount for easy backup/access)
      # Contains: ChromaDB, SQLite checkpoints.db, conversations_metadata.json
      - ./memory_db:/app/memory_db
      # Config files come from Docker image (updated with each deployment)
      # Removed volume mount to ensure prompt.txt and other config files are always up-to-date
      # Mount static files for admin UI
      - ./static:/app/static:ro
      # Optional: Mount logs directory for debugging
      - ./logs:/app/logs
      # Google Sheets credentials (optional - only if using Google Sheets)
      # Mount your service account JSON file to /app/credentials/google-sheets-service-account.json
      # Then set GOOGLE_SHEETS_CREDENTIALS_PATH=/app/credentials/google-sheets-service-account.json
      - ./credentials:/app/credentials:ro
    
    restart: unless-stopped
    # Note: User switching is handled by entrypoint.sh for proper volume permissions
    
    # Health check with proper timeouts for production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Increased for LangChain/LangGraph initialization
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - ict_agent_network

networks:
  ict_agent_network:
    driver: bridge
