services:
  # Redis is optional - app will work without it (uses in-memory cache)
  # To use Redis, start with: docker compose --profile with-redis up
  redis:
    image: redis:7-alpine
    container_name: ict_agent_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    # For local: no password by default. Set REDIS_PASSWORD in .env for production
    # Note: If REDIS_PASSWORD is set, you'll need to update the command manually or use an entrypoint script
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ict_agent_network
    profiles:
      - with-redis  # Only start Redis if explicitly requested: docker compose --profile with-redis up

  api:
    build: 
      context: .
      dockerfile: docker/Dockerfile
    image: kamilzafar/ict_agent:latest
    container_name: ict_agent_api
    ports:
      - "${API_PORT:-8009}:8009"  # Expose API port for OAuth2 callbacks
    env_file:
      - .env
    environment:
      - MEMORY_DB_PATH=/app/memory_db
      - ENVIRONMENT=production
      # Supabase Configuration
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_KEY=${SUPABASE_KEY:-}
      - SUPABASE_REALTIME_ENABLED=${SUPABASE_REALTIME_ENABLED:-true}
    
    # Resource limits to prevent OOM kills during ChromaDB indexing
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    volumes:
      # Persist memory database (bind mount for easy backup/access)
      - ./memory_db:/app/memory_db
      # Mount config for hot-reload (template editor)
      - ./config:/app/config
      # Mount static files for admin UI
      - ./static:/app/static:ro
      # Optional: Mount logs directory for debugging
      - ./logs:/app/logs
    
    # Redis is optional - remove depends_on if not using Redis
    # depends_on:
    #   redis:
    #     condition: service_healthy
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - ict_agent_network

volumes:
  redis_data:
    driver: local

networks:
  ict_agent_network:
    driver: bridge
